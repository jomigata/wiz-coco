# WizCoCo ë³´ì•ˆ ê°ì‚¬ ì›Œí¬í”Œë¡œìš°
# 30ë…„ ê²½ë ¥ í’€ìŠ¤íƒ í”„ë¡œê·¸ë˜ë¨¸ ê²€í†  ì™„ë£Œ
name: ğŸ”’ ë³´ì•ˆ ê°ì‚¬

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œì— ì‹¤í–‰
    - cron: '0 9 * * 1'
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'src/**'

jobs:
  security-audit:
    name: ğŸ” ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci --legacy-peer-deps
      
    - name: ğŸ”’ npm ë³´ì•ˆ ê°ì‚¬
      run: |
        echo "ğŸ”’ npm ë³´ì•ˆ ê°ì‚¬ ì‹œì‘..."
        npm audit --audit-level=moderate --json > audit-report.json || true
        
        # ê°ì‚¬ ê²°ê³¼ ë¶„ì„
        if [ -f "audit-report.json" ]; then
          echo "ğŸ“Š ë³´ì•ˆ ê°ì‚¬ ê²°ê³¼:"
          cat audit-report.json | jq -r '.metadata.vulnerabilities | to_entries[] | "\(.key): \(.value)"' || echo "ê°ì‚¬ ê²°ê³¼ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        fi
        
    - name: ğŸ” ì½”ë“œ ë³´ì•ˆ ê²€ì‚¬
      run: |
        echo "ğŸ” ì½”ë“œ ë³´ì•ˆ ê²€ì‚¬ ì‹œì‘..."
        
        # í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸ ê²€ì‚¬
        echo "ğŸ” í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸ ê²€ì‚¬:"
        if grep -r "password.*=.*['\"][^'\"]*['\"]" src/ --exclude-dir=node_modules; then
          echo "âš ï¸  í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
        else
          echo "âœ… í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤."
        fi
        
        # API í‚¤ ë…¸ì¶œ ê²€ì‚¬
        echo "ğŸ” API í‚¤ ë…¸ì¶œ ê²€ì‚¬:"
        if grep -r "api_key.*=.*['\"][^'\"]*['\"]" src/ --exclude-dir=node_modules; then
          echo "âš ï¸  í•˜ë“œì½”ë”©ëœ API í‚¤ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
        else
          echo "âœ… í•˜ë“œì½”ë”©ëœ API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤."
        fi
        
        # í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš© ê²€ì‚¬
        echo "ğŸ” í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš© ê²€ì‚¬:"
        env_vars=$(grep -r "process\.env\." src/ --exclude-dir=node_modules | wc -l)
        echo "âœ… í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©: $env_varsê°œ"
        
    - name: ğŸ“Š ë³´ì•ˆ ë¦¬í¬íŠ¸ ìƒì„±
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-audit-report
        path: audit-report.json
        retention-days: 90
        
    - name: ğŸ”” ë³´ì•ˆ ì•Œë¦¼
      if: failure()
      run: |
        echo "ğŸš¨ ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ” ì¦‰ì‹œ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤."
        echo "ğŸ“Š ìƒì„¸ ë¦¬í¬íŠ¸ëŠ” ì•„í‹°íŒ©íŠ¸ì—ì„œ í™•ì¸í•˜ì„¸ìš”." 