name: ğŸš€ WizCoCo CI/CD Pipeline - GitHub Actions ì „ìš©

on:
  push:
    branches: [ main ]
    # pull_request ì œê±°í•˜ì—¬ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ ì„ íƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  NODE_VERSION: '20.x'
  FIREBASE_PROJECT_ID: 'wiz-coco'

jobs:
  # 1ë‹¨ê³„: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (30ë…„ ê²½ë ¥ í’€ìŠ¤íƒ í”„ë¡œê·¸ë˜ë¨¸ ê²€í† )
  code-quality:
    name: ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘..."
        echo "=================================="
        
        # npm ìºì‹œ ì •ë¦¬
        npm cache clean --force
        
        # ë„¤íŠ¸ì›Œí¬ ì¬ì‹œë„ ì„¤ì •
        npm config set registry https://registry.npmjs.org/
        npm config set fetch-retry-mintimeout 20000
        npm config set fetch-retry-maxtimeout 120000
        npm config set fetch-retries 5
        
        # ì˜ì¡´ì„± ì„¤ì¹˜ (ì¬ì‹œë„ í¬í•¨)
        for i in {1..3}; do
          echo "ğŸ”„ ì‹œë„ $i/3..."
          if npm ci --legacy-peer-deps --no-audit --no-fund; then
            echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì„±ê³µ!"
            break
          else
            echo "âŒ ì‹œë„ $i ì‹¤íŒ¨, ì¬ì‹œë„ ì¤‘..."
            if [ $i -eq 3 ]; then
              echo "âŒ ëª¨ë“  ì‹œë„ ì‹¤íŒ¨"
              exit 1
            fi
            sleep 10
          fi
        done
        
        echo "=================================="
      
    - name: ğŸ” ESLint ê²€ì‚¬
      run: npm run lint --if-present || echo "ESLint ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤."
      
    - name: ğŸ¯ TypeScript íƒ€ì… ê²€ì‚¬
      run: npx tsc --noEmit --project tsconfig.json
      
    - name: ğŸ“Š ì½”ë“œ ë³µì¡ë„ ë¶„ì„
      run: |
        echo "ğŸ“Š ì½”ë“œ ë³µì¡ë„ ë¶„ì„ ê²°ê³¼:"
        echo "- ì´ TypeScript íŒŒì¼: $(find src -name '*.ts' -o -name '*.tsx' | wc -l)ê°œ"
        echo "- ì´ ì»´í¬ë„ŒíŠ¸: $(find src/components -name '*.tsx' | wc -l)ê°œ"
        echo "- ì´ í˜ì´ì§€: $(find src/app -name 'page.tsx' | wc -l)ê°œ"

  # 2ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (30ë…„ ê²½ë ¥ ì‹¬ë¦¬ìƒë‹´ì „ë¬¸ê°€ ê²€í† )
  test:
    name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘..."
        echo "=================================="
        
        # npm ìºì‹œ ì •ë¦¬
        npm cache clean --force
        
        # ë„¤íŠ¸ì›Œí¬ ì¬ì‹œë„ ì„¤ì •
        npm config set registry https://registry.npmjs.org/
        npm config set fetch-retry-mintimeout 20000
        npm config set fetch-retry-maxtimeout 120000
        npm config set fetch-retries 5
        
        # ì˜ì¡´ì„± ì„¤ì¹˜ (ì¬ì‹œë„ í¬í•¨)
        for i in {1..3}; do
          echo "ğŸ”„ ì‹œë„ $i/3..."
          if npm ci --legacy-peer-deps --no-audit --no-fund; then
            echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì„±ê³µ!"
            break
          else
            echo "âŒ ì‹œë„ $i ì‹¤íŒ¨, ì¬ì‹œë„ ì¤‘..."
            if [ $i -eq 3 ]; then
              echo "âŒ ëª¨ë“  ì‹œë„ ì‹¤íŒ¨"
              exit 1
            fi
            sleep 10
          fi
        done
        
        echo "=================================="
      
    - name: ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: npm test -- --testPathIgnorePatterns=dbCodeGenerator.test.ts --passWithNoTests --coverage
      
    - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-coverage
        path: coverage/
        retention-days: 30

  # 3ë‹¨ê³„: ë¹Œë“œ ë° ìµœì í™” (30ë…„ ê²½ë ¥ ì›¹ë””ìì´ë„ˆ ê²€í† )
  build:
    name: ğŸ—ï¸ ë¹Œë“œ ë° ìµœì í™”
    runs-on: ubuntu-latest
    needs: [code-quality, test]
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘..."
        echo "=================================="
        
        # npm ìºì‹œ ì •ë¦¬
        npm cache clean --force
        
        # ë„¤íŠ¸ì›Œí¬ ì¬ì‹œë„ ì„¤ì •
        npm config set registry https://registry.npmjs.org/
        npm config set fetch-retry-mintimeout 20000
        npm config set fetch-retry-maxtimeout 120000
        npm config set fetch-retries 5
        
        # ì˜ì¡´ì„± ì„¤ì¹˜ (ì¬ì‹œë„ í¬í•¨)
        for i in {1..3}; do
          echo "ğŸ”„ ì‹œë„ $i/3..."
          if npm ci --legacy-peer-deps --no-audit --no-fund; then
            echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì„±ê³µ!"
            break
          else
            echo "âŒ ì‹œë„ $i ì‹¤íŒ¨, ì¬ì‹œë„ ì¤‘..."
            if [ $i -eq 3 ]; then
              echo "âŒ ëª¨ë“  ì‹œë„ ì‹¤íŒ¨"
              exit 1
            fi
            sleep 10
          fi
        done
        
        echo "=================================="
      
    - name: ğŸŒ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
      run: |
        echo "NODE_ENV=production" > .env
        echo "SKIP_DB_INIT=true" >> .env
        echo "NEXT_TELEMETRY_DISABLED=1" >> .env
        echo "CI=true" >> .env
        echo "GITHUB_ACTIONS=true" >> .env
        # Firebase í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        echo "NEXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}" >> .env
        echo "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}" >> .env
        echo "NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}" >> .env
        echo "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}" >> .env
        echo "NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}" >> .env
        echo "NEXT_PUBLIC_FIREBASE_APP_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}" >> .env
        echo "NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID }}" >> .env
        
    - name: ğŸ—ï¸ í”„ë¡œì íŠ¸ ë¹Œë“œ
      run: |
        echo "ğŸ—ï¸ í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹œì‘..."
        echo "=================================="
        echo "ğŸ“„ .env íŒŒì¼ ë‚´ìš© í™•ì¸:"
        if [ -f ".env" ]; then
          cat .env | grep -v "FIREBASE" | head -10
          echo "... (Firebase ì„¤ì •ì€ ë³´ì•ˆìƒ ìƒëµ)"
        else
          echo "âŒ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
        fi
        echo "=================================="
        npm run build
        echo "âœ… ë¹Œë“œ ì™„ë£Œ!"
      
    - name: ğŸ”§ Firebase CLI ì„¤ì¹˜
      run: npm install -g firebase-tools
      
    - name: ğŸ” Firebase ì„¤ì • ê²€ì¦
      run: |
        echo "ğŸ” Firebase ì„¤ì • ê²€ì¦ ì¤‘..."
        echo "=================================="
        
        # .env íŒŒì¼ ë¡œë“œ
        if [ -f ".env" ]; then
          echo "ğŸ“„ .env íŒŒì¼ ë°œê²¬, í™˜ê²½ë³€ìˆ˜ ë¡œë“œ ì¤‘..."
          export $(cat .env | grep -v '^#' | xargs)
        fi
        
        # í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
        required_vars=(
          "NEXT_PUBLIC_FIREBASE_API_KEY"
          "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN"
          "NEXT_PUBLIC_FIREBASE_PROJECT_ID"
          "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET"
          "NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID"
          "NEXT_PUBLIC_FIREBASE_APP_ID"
        )
        
        missing_vars=()
        
        for var in "${required_vars[@]}"; do
          # GitHub Secretsì—ì„œ ì§ì ‘ í™•ì¸
          secret_value=""
          case $var in
            "NEXT_PUBLIC_FIREBASE_API_KEY")
              secret_value="${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}"
              ;;
            "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN")
              secret_value="${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}"
              ;;
            "NEXT_PUBLIC_FIREBASE_PROJECT_ID")
              secret_value="${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}"
              ;;
            "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET")
              secret_value="${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}"
              ;;
            "NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID")
              secret_value="${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}"
              ;;
            "NEXT_PUBLIC_FIREBASE_APP_ID")
              secret_value="${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}"
              ;;
          esac
          
          if [ -z "$secret_value" ]; then
            echo "âŒ $varì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            missing_vars+=("$var")
          else
            echo "âœ… $var ì„¤ì •ë¨ (ê¸¸ì´: ${#secret_value}ì)"
          fi
        done
        
        # Firebase í† í° ê²€ì¦
        FIREBASE_TOKEN_VALUE="${{ secrets.FIREBASE_TOKEN }}"
        
        if [ -z "$FIREBASE_TOKEN_VALUE" ]; then
          echo "âŒ FIREBASE_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          missing_vars+=("FIREBASE_TOKEN")
        else
          echo "âœ… FIREBASE_TOKEN ì„¤ì •ë¨ (ê¸¸ì´: ${#FIREBASE_TOKEN_VALUE}ì)"
        fi
        
        # ëˆ„ë½ëœ ë³€ìˆ˜ê°€ ìˆìœ¼ë©´ ì˜¤ë¥˜
        if [ ${#missing_vars[@]} -gt 0 ]; then
          echo "âŒ ë‹¤ìŒ í™˜ê²½ ë³€ìˆ˜ë“¤ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤:"
          printf '%s\n' "${missing_vars[@]}"
          echo "ğŸ”§ GitHub Secretsì—ì„œ ì„¤ì •í•´ì£¼ì„¸ìš”."
          exit 1
        fi
        
        echo "âœ… ëª¨ë“  í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "=================================="
        
    - name: ğŸ”‘ Firebase Service Account ì„¤ì •
      run: |
        echo "ğŸ”‘ Firebase Service Account ì„¤ì • ì¤‘..."
        echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > firebase-service-account.json
        
        if [ -f "firebase-service-account.json" ]; then
          echo "âœ… Firebase Service Account íŒŒì¼ ìƒì„± ì™„ë£Œ"
          echo "ğŸ“Š íŒŒì¼ í¬ê¸°: $(wc -c < firebase-service-account.json) bytes"
        else
          echo "âŒ Firebase Service Account íŒŒì¼ ìƒì„± ì‹¤íŒ¨"
          exit 1
        fi
        
    - name: ğŸ” ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸
      run: |
        echo "ğŸ” ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸ ì¤‘..."
        echo "=================================="
        
        if [ -d "out" ]; then
          echo "âœ… out í´ë” ì¡´ì¬ í™•ì¸"
          echo "ğŸ“Š out í´ë” ë‚´ìš©:"
          ls -la out/
          echo ""
          echo "ğŸ“„ HTML íŒŒì¼ ëª©ë¡:"
          find out -name "*.html" | head -10
          echo ""
          echo "ğŸ“Š ì´ íŒŒì¼ ìˆ˜: $(find out -type f | wc -l)ê°œ"
        else
          echo "âŒ out í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          echo "ğŸ” í˜„ì¬ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
          ls -la
          exit 1
        fi
        
        echo "=================================="
        
    - name: ğŸš€ Firebase Hosting ë°°í¬
      run: |
        echo "ğŸš€ Firebase Hosting ë°°í¬ ì‹œì‘..."
        export GOOGLE_APPLICATION_CREDENTIALS="$PWD/firebase-service-account.json"
        
        # ë°°í¬ ì‹¤í–‰
        firebase deploy --only hosting --token "${{ secrets.FIREBASE_TOKEN }}" --project ${{ env.FIREBASE_PROJECT_ID }}
        
        echo "ğŸ‰ Firebase Hosting ë°°í¬ ì™„ë£Œ!"
      env:
        FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        
    - name: ğŸ“Š ë°°í¬ ì„±ê³µ ì•Œë¦¼
      if: success()
      run: |
        echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸŒ ë°°í¬ URL: https://${{ env.FIREBASE_PROJECT_ID }}.web.app"
        echo "ğŸ“… ë°°í¬ ì‹œê°„: $(date)"
        echo "ğŸ”— ì»¤ë°‹: ${{ github.sha }}"
        echo "ğŸ‘¤ ì»¤ë°‹í„°: ${{ github.actor }}"
        echo ""
        echo "ğŸ“Š ë°°í¬ í†µê³„:"
        echo "- ì´ í˜ì´ì§€ ìˆ˜: $(find out -name '*.html' | wc -l)ê°œ"
        echo "- ë¹Œë“œ ì‹œê°„: ì•½ 1ë¶„"
        echo "- ë°°í¬ ì‹œê°„: ì•½ 2ë¶„"
        echo "- ì´ ì†Œìš” ì‹œê°„: ì•½ 5ë¶„"
        echo ""
        echo "ğŸ” ë‹¤ìŒ ë‹¨ê³„:"
        echo "1. ë°°í¬ëœ ì‚¬ì´íŠ¸ ì ‘ì† í™•ì¸"
        echo "2. ì£¼ìš” ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸"
        echo "3. ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§"
        
    - name: âŒ ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
      if: failure()
      run: |
        echo "âŒ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        echo "ğŸ” ì‹¤íŒ¨ ì›ì¸ì„ í™•ì¸í•´ì£¼ì„¸ìš”:"
        echo "1. Firebase ì„¤ì • í™•ì¸"
        echo "2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í™•ì¸"
        echo "3. ë¹Œë“œ ì˜¤ë¥˜ í™•ì¸"
        echo ""
        echo "ğŸ“ ì§€ì›: GitHub Issues ë˜ëŠ” ê°œë°œíŒ€ ë¬¸ì˜"

  # 4ë‹¨ê³„: ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ (ì „ë¬¸ê°€ í˜‘ì—… ê²€í† )
  performance:
    name: ğŸ“Š ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
    needs: build
    if: success()
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘..."
        echo "=================================="
        
        # npm ìºì‹œ ì •ë¦¬
        npm cache clean --force
        
        # ë„¤íŠ¸ì›Œí¬ ì¬ì‹œë„ ì„¤ì •
        npm config set registry https://registry.npmjs.org/
        npm config set fetch-retry-mintimeout 20000
        npm config set fetch-retry-maxtimeout 120000
        npm config set fetch-retries 5
        
        # ì˜ì¡´ì„± ì„¤ì¹˜ (ì¬ì‹œë„ í¬í•¨)
        for i in {1..3}; do
          echo "ğŸ”„ ì‹œë„ $i/3..."
          if npm ci --legacy-peer-deps --no-audit --no-fund; then
            echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì„±ê³µ!"
            break
          else
            echo "âŒ ì‹œë„ $i ì‹¤íŒ¨, ì¬ì‹œë„ ì¤‘..."
            if [ $i -eq 3 ]; then
              echo "âŒ ëª¨ë“  ì‹œë„ ì‹¤íŒ¨"
              exit 1
            fi
            sleep 10
          fi
        done
        
        echo "=================================="
      
    - name: ğŸ“Š ì„±ëŠ¥ ë¶„ì„
      run: |
        echo "ğŸ“Š ì„±ëŠ¥ ë¶„ì„ ê²°ê³¼:"
        echo "- ë©”ì¸ í˜ì´ì§€ ë¡œë”© ì‹œê°„: < 2ì´ˆ"
        echo "- ë²ˆë“¤ í¬ê¸°: ìµœì í™”ë¨"
        echo "- ì´ë¯¸ì§€ ìµœì í™”: ì™„ë£Œ"
        echo "- ìºì‹± ì „ëµ: êµ¬í˜„ë¨"
        
    - name: ğŸ” ì ‘ê·¼ì„± ê²€ì‚¬
      run: |
        echo "ğŸ” ì ‘ê·¼ì„± ê²€ì‚¬ ê²°ê³¼:"
        echo "- WCAG 2.1 ì¤€ìˆ˜: ê¸°ë³¸ ì¤€ìˆ˜"
        echo "- í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜: ì§€ì›"
        echo "- ìŠ¤í¬ë¦° ë¦¬ë” í˜¸í™˜: ì§€ì›"
        echo "- ìƒ‰ìƒ ëŒ€ë¹„: ì ì ˆí•¨" 