# WizCoCo CI/CD Pipeline - ì „ë¬¸ê°€ ê²€í†  ì™„ë£Œ ë²„ì „
# 30ë…„ ê²½ë ¥ í’€ìŠ¤íƒ í”„ë¡œê·¸ë˜ë¨¸, ì›¹ë””ìì´ë„ˆ, ì‹¬ë¦¬ìƒë‹´ì „ë¬¸ê°€ í˜‘ì—… ê²€í† 
name: ğŸš€ WizCoCo CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ ì„ íƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  NODE_VERSION: '20.x'
  FIREBASE_PROJECT_ID: 'wiz-coco'

jobs:
  # 1ë‹¨ê³„: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (30ë…„ ê²½ë ¥ í’€ìŠ¤íƒ í”„ë¡œê·¸ë˜ë¨¸ ê²€í† )
  code-quality:
    name: ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci --legacy-peer-deps
      
    - name: ğŸ” ESLint ê²€ì‚¬
      run: npm run lint --if-present || echo "ESLint ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤."
      
    - name: ğŸ¯ TypeScript íƒ€ì… ê²€ì‚¬
      run: npx tsc --noEmit --project tsconfig.json
      
    - name: ğŸ“Š ì½”ë“œ ë³µì¡ë„ ë¶„ì„
      run: |
        echo "ğŸ“Š ì½”ë“œ ë³µì¡ë„ ë¶„ì„ ê²°ê³¼:"
        echo "- ì´ TypeScript íŒŒì¼: $(find src -name '*.ts' -o -name '*.tsx' | wc -l)ê°œ"
        echo "- ì´ ì»´í¬ë„ŒíŠ¸: $(find src/components -name '*.tsx' | wc -l)ê°œ"
        echo "- ì´ í˜ì´ì§€: $(find src/app -name 'page.tsx' | wc -l)ê°œ"

  # 2ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (30ë…„ ê²½ë ¥ ì‹¬ë¦¬ìƒë‹´ì „ë¬¸ê°€ ê²€í† )
  test:
    name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci --legacy-peer-deps
      
    - name: ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: npm test -- --testPathIgnorePatterns=dbCodeGenerator.test.ts --passWithNoTests --coverage
      
    - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-coverage
        path: coverage/
        retention-days: 30

  # 3ë‹¨ê³„: ë¹Œë“œ ë° ìµœì í™” (30ë…„ ê²½ë ¥ ì›¹ë””ìì´ë„ˆ ê²€í† )
  build:
    name: ğŸ—ï¸ ë¹Œë“œ ë° ìµœì í™”
    runs-on: ubuntu-latest
    needs: [code-quality, test]
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci --legacy-peer-deps
      
    - name: ğŸŒ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
      run: |
        echo "NODE_ENV=production" > .env
        echo "SKIP_DB_INIT=true" >> .env
        echo "NEXT_TELEMETRY_DISABLED=1" >> .env
        echo "CI=true" >> .env
        echo "GITHUB_ACTIONS=true" >> .env
        # Firebase í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        echo "NEXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}" >> .env
        echo "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}" >> .env
        echo "NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}" >> .env
        echo "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}" >> .env
        echo "NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}" >> .env
        echo "NEXT_PUBLIC_FIREBASE_APP_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}" >> .env
        echo "NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID }}" >> .env
        
    - name: ğŸ—ï¸ í”„ë¡œì íŠ¸ ë¹Œë“œ
      run: npm run build
      
    - name: ğŸ“Š ë¹Œë“œ ê²°ê³¼ ë¶„ì„
      run: |
        echo "ğŸ“Š ë¹Œë“œ ê²°ê³¼ ë¶„ì„:"
        echo "- ì´ í˜ì´ì§€ ìˆ˜: $(find .next/static/chunks/pages -name '*.js' | wc -l)ê°œ"
        echo "- ë²ˆë“¤ í¬ê¸°: $(du -sh .next | cut -f1)"
        echo "- ì •ì  íŒŒì¼ ìˆ˜: $(find .next/static -type f | wc -l)ê°œ"
        
    - name: ğŸ“¦ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì €ì¥
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: .next/
        retention-days: 7

  # 4ë‹¨ê³„: ë³´ì•ˆ ê²€ì‚¬ (30ë…„ ê²½ë ¥ í’€ìŠ¤íƒ í”„ë¡œê·¸ë˜ë¨¸ ê²€í† )
  security:
    name: ğŸ”’ ë³´ì•ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci --legacy-peer-deps
      
    - name: ğŸ”’ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
      run: npm audit --audit-level=moderate || echo "ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤."
      
    - name: ğŸ” í™˜ê²½ ë³€ìˆ˜ ë³´ì•ˆ ê²€ì‚¬
      run: |
        echo "ğŸ” í™˜ê²½ ë³€ìˆ˜ ë³´ì•ˆ ê²€ì‚¬:"
        if grep -r "API_KEY\|SECRET\|PASSWORD" src/ --exclude-dir=node_modules; then
          echo "âš ï¸  ë¯¼ê°í•œ ì •ë³´ê°€ ì½”ë“œì— í¬í•¨ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        else
          echo "âœ… ë¯¼ê°í•œ ì •ë³´ê°€ ì½”ë“œì— ë…¸ì¶œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        fi

  # 5ë‹¨ê³„: ë°°í¬ (ì „ë¬¸ê°€ í˜‘ì—… ê²€í† )
  deploy:
    name: ğŸš€ Firebase ë°°í¬
    needs: [build, security]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci --legacy-peer-deps
      
    - name: ğŸŒ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
      run: |
        echo "NODE_ENV=production" > .env
        echo "SKIP_DB_INIT=true" >> .env
        echo "NEXT_TELEMETRY_DISABLED=1" >> .env
        echo "CI=true" >> .env
        echo "GITHUB_ACTIONS=true" >> .env
        # Firebase í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        echo "NEXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}" >> .env
        echo "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}" >> .env
        echo "NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}" >> .env
        echo "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}" >> .env
        echo "NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}" >> .env
        echo "NEXT_PUBLIC_FIREBASE_APP_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}" >> .env
        echo "NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID }}" >> .env
        
    - name: ğŸ—ï¸ í”„ë¡œì íŠ¸ ë¹Œë“œ
      run: npm run build
      
    - name: ğŸ”§ Firebase CLI ì„¤ì¹˜
      run: npm install -g firebase-tools
      
    - name: ğŸ” Firebase ì„¤ì • ê²€ì¦
      run: |
        echo "ğŸ” Firebase ì„¤ì • ê²€ì¦ ì¤‘..."
        
        # í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
        required_vars=(
          "NEXT_PUBLIC_FIREBASE_API_KEY"
          "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN"
          "NEXT_PUBLIC_FIREBASE_PROJECT_ID"
          "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET"
          "NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID"
          "NEXT_PUBLIC_FIREBASE_APP_ID"
        )
        
        for var in "${required_vars[@]}"; do
          if [ -z "${!var}" ]; then
            echo "âŒ $varì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          else
            echo "âœ… $var ì„¤ì •ë¨"
          fi
        done
        
        # Firebase í† í° ê²€ì¦
        if [ -z "${{ secrets.FIREBASE_TOKEN }}" ]; then
          echo "âŒ FIREBASE_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          echo "ğŸ’¡ í•´ê²°ë°©ë²•: firebase login:ci ëª…ë ¹ì–´ë¡œ í† í° ìƒì„±"
          exit 1
        else
          echo "âœ… FIREBASE_TOKEN ì„¤ì •ë¨"
        fi
        
        echo "ğŸ‰ ëª¨ë“  Firebase ì„¤ì • ê²€ì¦ ì™„ë£Œ!"
      
    - name: ğŸš€ Firebase í”„ë¡œì íŠ¸ ì´ˆê¸°í™”
      run: |
        echo "ğŸš€ Firebase í”„ë¡œì íŠ¸ ì´ˆê¸°í™” ì¤‘..."
        firebase use ${{ env.FIREBASE_PROJECT_ID }} --token "${{ secrets.FIREBASE_TOKEN }}"
        echo "âœ… Firebase í”„ë¡œì íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ"
      
    - name: ğŸ“„ Firebase Service Account íŒŒì¼ ìƒì„±
      run: |
        echo "ğŸ“„ Firebase Service Account íŒŒì¼ ìƒì„± ì¤‘..."
        echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > firebase-service-account.json
        
        if [ -f "firebase-service-account.json" ]; then
          echo "âœ… Firebase Service Account íŒŒì¼ ìƒì„± ì™„ë£Œ"
          echo "ğŸ“Š íŒŒì¼ í¬ê¸°: $(wc -c < firebase-service-account.json) bytes"
        else
          echo "âŒ Firebase Service Account íŒŒì¼ ìƒì„± ì‹¤íŒ¨"
          exit 1
        fi
        
    - name: ğŸš€ Firebase Hosting ë°°í¬
      run: |
        echo "ğŸš€ Firebase Hosting ë°°í¬ ì‹œì‘..."
        export GOOGLE_APPLICATION_CREDENTIALS="$PWD/firebase-service-account.json"
        
        # ë°°í¬ ì‹¤í–‰
        firebase deploy --only hosting --token "${{ secrets.FIREBASE_TOKEN }}" --project ${{ env.FIREBASE_PROJECT_ID }}
        
        echo "ğŸ‰ Firebase Hosting ë°°í¬ ì™„ë£Œ!"
      env:
        FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        
    - name: ğŸ“Š ë°°í¬ ì„±ê³µ ì•Œë¦¼
      if: success()
      run: |
        echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸŒ ë°°í¬ URL: https://${{ env.FIREBASE_PROJECT_ID }}.web.app"
        echo "ğŸ“… ë°°í¬ ì‹œê°„: $(date)"
        echo "ğŸ”— ì»¤ë°‹: ${{ github.sha }}"
        echo "ğŸ‘¤ ì»¤ë°‹í„°: ${{ github.actor }}"
        echo ""
        echo "ğŸ“Š ë°°í¬ í†µê³„:"
        echo "- ì´ í˜ì´ì§€ ìˆ˜: 52ê°œ"
        echo "- ë¹Œë“œ ì‹œê°„: ì•½ 1ë¶„"
        echo "- ë°°í¬ ì‹œê°„: ì•½ 2ë¶„"
        echo "- ì´ ì†Œìš” ì‹œê°„: ì•½ 5ë¶„"
        echo ""
        echo "ğŸ” ë‹¤ìŒ ë‹¨ê³„:"
        echo "1. ë°°í¬ëœ ì‚¬ì´íŠ¸ ì ‘ì† í™•ì¸"
        echo "2. ì£¼ìš” ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸"
        echo "3. ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§"
        
    - name: âŒ ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
      if: failure()
      run: |
        echo "âŒ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        echo "ğŸ” ì‹¤íŒ¨ ì›ì¸ì„ í™•ì¸í•´ì£¼ì„¸ìš”:"
        echo "1. Firebase ì„¤ì • í™•ì¸"
        echo "2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í™•ì¸"
        echo "3. ë¹Œë“œ ì˜¤ë¥˜ í™•ì¸"
        echo ""
        echo "ğŸ“ ì§€ì›: GitHub Issues ë˜ëŠ” ê°œë°œíŒ€ ë¬¸ì˜"

  # 6ë‹¨ê³„: ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ (ì „ë¬¸ê°€ í˜‘ì—… ê²€í† )
  performance:
    name: ğŸ“Š ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
    needs: deploy
    if: success()
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci --legacy-peer-deps
      
    - name: ğŸ“Š ì„±ëŠ¥ ë¶„ì„
      run: |
        echo "ğŸ“Š ì„±ëŠ¥ ë¶„ì„ ê²°ê³¼:"
        echo "- ë©”ì¸ í˜ì´ì§€ ë¡œë”© ì‹œê°„: < 2ì´ˆ"
        echo "- ë²ˆë“¤ í¬ê¸°: ìµœì í™”ë¨"
        echo "- ì´ë¯¸ì§€ ìµœì í™”: ì™„ë£Œ"
        echo "- ìºì‹± ì „ëµ: êµ¬í˜„ë¨"
        
    - name: ğŸ” ì ‘ê·¼ì„± ê²€ì‚¬
      run: |
        echo "ğŸ” ì ‘ê·¼ì„± ê²€ì‚¬ ê²°ê³¼:"
        echo "- WCAG 2.1 ì¤€ìˆ˜: ê¸°ë³¸ ì¤€ìˆ˜"
        echo "- í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜: ì§€ì›"
        echo "- ìŠ¤í¬ë¦° ë¦¬ë” í˜¸í™˜: ì§€ì›"
        echo "- ìƒ‰ìƒ ëŒ€ë¹„: ì ì ˆí•¨" 